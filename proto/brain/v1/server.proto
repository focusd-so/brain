syntax = "proto3";

package brain.v1;

option go_package = "github.com/focusd-so/brain/gen/brain/v1;brainv1";

import "buf/validate/validate.proto";
import "common/v1/common.proto";

service BrainService {
    // ---------------------------------------------------------
    // AUTHENTICATION
    // ---------------------------------------------------------
    // Exchanges a Hardware Fingerprint for a PASETO Session Token.
    // Note: Request requires HMAC Headers (X-Signature, X-Timestamp, X-Nonce).
    rpc DeviceHandshake(DeviceHandshakeRequest) returns (DeviceHandshakeResponse);

    // ---------------------------------------------------------
    // CLASSIFICATION
    // ---------------------------------------------------------
    // Analyze a specific app window to determine focus level.
    rpc ClassifyApplication(ClassifyApplicationRequest) returns (ClassifyApplicationResponse);
    
    // Analyze a URL (browser tab) to determine focus level.
    rpc ClassifyWebsite(ClassifyWebsiteRequest) returns (ClassifyWebsiteResponse);

    // ---------------------------------------------------------
    // INTELLIGENCE (AI AGENTS)
    // ---------------------------------------------------------
    rpc AgentSession(stream AgentSessionRequest) returns (stream AgentSessionResponse);

    // ---------------------------------------------------------
    // OAUTH2 RELAY
    // ---------------------------------------------------------
    rpc OAuth2GetAuthorizationURL(OAuth2GetAuthorizationURLRequest) returns (OAuth2GetAuthorizationURLResponse);
    rpc OAuth2ExchangeAuthorizationCode(OAuth2ExchangeAuthorizationCodeRequest) returns (OAuth2ExchangeAuthorizationCodeResponse);
    rpc OAuth2RefreshAccessToken(OAuth2RefreshAccessTokenRequest) returns (OAuth2RefreshAccessTokenResponse);
    rpc OAuth2RevokeAccessToken(OAuth2RevokeAccessTokenRequest) returns (OAuth2RevokeAccessTokenResponse);
}

// =============================================================================
// AUTH MESSAGES
// =============================================================================

message DeviceHandshakeRequest {
    string device_fingerprint = 1;
    string os_platform = 2;       // e.g. "darwin", "windows" - for analytics
    string os_version = 3;        // e.g. "14.2.1"
    string app_version = 4;       // e.g. "1.0.4" - allows force-update checks
}

message DeviceHandshakeResponse {
    string session_token = 1;     // The PASETO v2.local token
    int64 expires_at = 2;         // Unix timestamp (hint for client refresh)
    
    // Limits / Account Status
    string account_role = 3;      // "anonymous", "pro"
    int32 remaining_daily_scans = 4; // If anonymous
}

// =============================================================================
// CLASSIFICATION MESSAGES
// =============================================================================

message ClassificationResult {
    string classification = 1; // "productive", "supporting", "neutral", "distracting"
    string reasoning = 2;
    float confidence_score = 3;   // 0.0 to 1.0 (How sure is the AI?)
    repeated string tags = 4; 
    optional string detected_project = 5; // e.g. "focusd" extracted from title
}

message ClassifyApplicationRequest {
    string application_name = 1;  // "Visual Studio Code"
    string application_bundle_id = 2; // "com.microsoft.VSCode"
    string window_title = 3;      // "main.go - focusd"
}

message ClassifyApplicationResponse {
    ClassificationResult classification = 1;
    
    // Metadata extraction (for Context correlation)
    optional string detected_project = 6; // e.g. "focusd" extracted from title
    optional string detected_file = 7;    // e.g. "main.go"
}

message ClassifyWebsiteRequest {
    string url = 1;
    string title = 2;
}

message ClassifyWebsiteResponse {
    ClassificationResult classification = 1;
}

// =============================================================================
// INTELLIGENCE MESSAGES
// =============================================================================

message AgentSessionRequest {
    // Agent and Tool definitions (sent during handshake from electron â†’ brain)
    message Agent {
        message Tool {
            string name = 1;
            string description = 2;
            // JSON Schema encoded as JSON string (can be unmarshalled into jsonschema)
            string input_schema = 3;
            string output_schema = 4;
        }

        string name = 1;
        string description = 2;
        string instruction = 3;
        repeated Tool tools = 4;
    }

    message TerminateExecution {
        string reason = 1;
    }
    
    message RunRequest {
        string instruction = 1;
        repeated Agent agents = 2;
        string user_message = 3;
    }

    // Response to brain's tool call request
    message ToolCallResponse {
        string request_id = 1;            // Correlates to AgentSessionResponse.ToolCallRequest.request_id
        
        enum Status {
            STATUS_UNSPECIFIED = 0;
            STATUS_SUCCESS = 1;
            STATUS_ERROR = 2;
            STATUS_TIMEOUT = 3;
        }
        Status status = 2;
        
        // JSON-encoded output matching tool's output_schema (populated on success)
        string output = 3;
        
        // Error message (populated on failure)
        string error = 4;
        
        // Execution time in milliseconds (for monitoring/debugging)
        int64 execution_time_ms = 5;
    }

    // Heartbeat to keep connection alive
    message Heartbeat {
        int64 timestamp = 1;
    }

    // Graceful session termination
    message SessionEnd {
        string reason = 1; // e.g., "user_requested", "error", "timeout"
    }

    oneof message {
        RunRequest run_request = 1;
        ToolCallResponse tool_call_response = 2;
        Heartbeat heartbeat = 3;
        SessionEnd session_end = 4;
    }
}

message AgentSessionResponse {
    // Session-level error (e.g., invalid tool requested, session error)
    message Error {
        string code = 1;    // e.g., "TOOL_NOT_FOUND", "SESSION_ERROR", "INVALID_INPUT"
        string message = 2;
        map<string, string> details = 3;
    }

    // Heartbeat acknowledgment
    message HeartbeatAck {
        int64 timestamp = 1;
    }

    // Session end acknowledgment
    message SessionEndAck {
        bool acknowledged = 1;
    }

    message ToolCallRequest {
        string request_id = 1;
        string tool_name = 2;
        string input = 3;
    }

    // Response with generated content from the agent
    message RunResponse {
        string content = 1;
    }

    oneof message {
        RunResponse run_response = 1;
        ToolCallRequest tool_call_request = 2;
        Error error = 3;
        HeartbeatAck heartbeat_ack = 4;
        SessionEndAck session_end_ack = 5;
    }
}

message OAuth2GetAuthorizationURLRequest {
    string provider = 1 [(buf.validate.field).string = { in: ["github", "slack", "jira", "google", "linear", "notion"] }]; 
    string state = 2 [(buf.validate.field).string.min_len = 1];              
    
    // PKCE Fields (Critical for Desktop Security)
    string code_challenge = 3 [(buf.validate.field).string.min_len = 1];     
    string code_challenge_method = 4 [(buf.validate.field).string.min_len = 1]; 
    
    repeated string scopes = 5; // Optional
}

message OAuth2GetAuthorizationURLResponse {
    string url = 1;                 // Full URL to open in system browser
}

message OAuth2ExchangeAuthorizationCodeRequest {
    string provider = 1;            // "github"
    string code = 2;                // The code received via Deep Link
    string redirect_uri = 3;        // "focusd://callback"
    
    // PKCE Verification
    // Sidecar sends the secret. Cloud verifies it against the Challenge 
    // sent in Step 1 before completing the exchange.
    string code_verifier = 4;       
}

message OAuth2ExchangeAuthorizationCodeResponse {
    common.OAuth2Token token = 1;
}

message OAuth2RefreshAccessTokenRequest {
    string provider = 1;
    string refresh_token = 2;
}

message OAuth2RefreshAccessTokenResponse {
    common.OAuth2Token token = 1;
}

message OAuth2RevokeAccessTokenRequest {
    string provider = 1;
    string token = 2; // Access or Refresh token
}

message OAuth2RevokeAccessTokenResponse {
    bool success = 1;
}
